!function(){"use strict";function t(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function e(t,n,i){if(t){if(0===t.length||"string"!=typeof t[0])throw"jsonml parse error: "+JSON.stringify(t);for(var o=t[0],s=t[1],r=s&&s.constructor===Object,c=r?2:1,a=0,d=c;d<t.length;d++)t[d]&&t[d].constructor!==Function&&a++;var u,l=o.split("~"),h=l[1],f=l[0].split("."),p=f[0].split("#"),m=p[0]||"div",g=p[1],_=f.slice(1);u=r?s:{},g&&(u._id=g),_.length&&(u._classes=_),h&&(u._ref=h);if(!n.open(m,u,a,i))for(var d=c,v=t.length;d<v;d++){var y=t[d];if(void 0!==y)switch(y.constructor){case Array:e(y,n,i);break;case Function:n.fnc(y,i);break;case String:n.text(y,i);break;case Number:case Boolean:n.text(""+y,i);break;default:n.obj(y,i)}}n.close(m,a,i)}}function n(t,n){e(t,new r,n)}function i(t,e){for(var i=0,o=t;i<o.length;i++){var s=o[i];if(s.constructor===String)IncrementalDOM.text(s);else if("toJsonML"in s){var r=s;n(r.toJsonML(),r)}else n(s,e)}}function o(t,e,n){IncrementalDOM.patch(t,function(t){return i(t,n)},e)}var s=function(){function t(){this._encoder=function(t){return encodeURIComponent(JSON.stringify(t))},this._decoder=function(t){return t?JSON.parse(decodeURIComponent(t)):void 0}}return t.prototype.onChange=function(t){var e=this;if(this._cb=t,"onhashchange"in window)onhashchange=function(){t(e.read())};else{var n=location.hash;this._iId&&clearInterval(this._iId),this._iId=setInterval(function(){location.hash!==n&&(n=location.hash,t(e.read()))},500)}return this},t.prototype.coders=function(t,e){return this._encoder=t,this._decoder=e,this},t.prototype.start=function(){return this._cb(this.read()),this},t.prototype.read=function(){var t=location.hash.slice(1);return this._decoder(t)},t.prototype.write=function(t){var e=this._encoder(t);return location.hash="#"+e,this},t}(),r=function(){function t(){}return t.prototype.open=function(t,e,n,i){var o=[],s=e._id,r=e._classes?e._classes:[],c=e._ref,a=e._widget;for(var d in e)if(e.hasOwnProperty(d))switch(d){case"_id":case"_classes":case"_ref":case"_key":case"_skip":case"_widget":break;case"id":s=e[d];break;case"classes":r=r.concat(e[d]);break;case"class":r=r.concat(e[d].split(" "));break;case"data":for(var u in e[d])e[d].hasOwnProperty(u)&&(e[d][u].constructor===String?o.push("data-"+u,e[d][u]):o.push("data-"+u,JSON.stringify(e[d][u])));break;case"styles":o.push("style",e[d]);break;default:"function"==typeof e[d]?o.push("on"+d,e[d]):o.push(d,e[d])}return r.length&&o.unshift("class",r.join(" ")),s&&o.unshift("id",s),IncrementalDOM.elementOpen.apply(IncrementalDOM,[t,e._key||null,null].concat(o)),e._skip&&IncrementalDOM.skip(),i&&c&&(i.refs[c]=IncrementalDOM.currentElement()),a&&"mount"in a&&a.mount.constructor===Function&&(a.mount(IncrementalDOM.currentElement()),IncrementalDOM.skip()),!!e._skip},t.prototype.close=function(t,e,n){IncrementalDOM.elementClose(t)},t.prototype.text=function(t,e){IncrementalDOM.text(t)},t.prototype.fnc=function(t,e){t(IncrementalDOM.currentElement())},t.prototype.obj=function(t,n){"toJsonML"in t?e(t.toJsonML(),this,t):this.text(""+t,n)},t}(),c=function(){function t(e){void 0===e&&(e=""),this.type="Widget",this.id=this.type+"-"+t.__count++,this.refs={},e&&(this.type=e)}return t.prototype.mount=function(t){if(void 0===t&&(t=document.body),"widget"in t){var e=t.widget;e&&e.umount()}if(!this.dom){this.dom=t,t.widget=this;o(t,this.render(),this),t.setAttribute("widget",this.type),this.onMount&&this.onMount()}return this},t.prototype.umount=function(){if(this.dom){this.onUmount&&this.onUmount(),this.dom.hasAttribute("widget")&&this.dom.removeAttribute("widget");for(var t=this.dom.querySelectorAll("[widget]"),e=0;e<t.length;e++){var n=t[e].widget;n&&n.umount()}for(;this.dom.firstChild;)this.dom.removeChild(this.dom.firstChild);this.dom.widget=void 0,this.dom=void 0}return this},t.prototype.update=function(){var t=this;return this.dom&&!this._updateSched&&(this._updateSched=setTimeout(function(){t.dom&&o(t.dom,t.render(),t),t._updateSched=null},0)),this},t.prototype.toJsonML=function(){var t=this;if(this.dom){if(!this._updateSched)return["div",{_skip:!0,_id:this.id,_key:this.id,widget:this.type}];clearTimeout(this._updateSched),this._updateSched=void 0}var e=this.render();return["div",{_id:this.id,_key:this.id,widget:this.type}].concat(e,[function(e){t.dom||(t.dom=e,e.widget=t,t.onMount&&t.onMount())}])},t.__count=0,t}();IncrementalDOM.notifications.nodesDeleted=function(t){t.forEach(function(t){if(1===t.nodeType&&"widget"in t){var e=t.widget;e&&e.umount()}})};var a=function(){function t(t){this._cbs={},this._ctx=t}return t.prototype.on=function(t,e){return t||(this._cb||(this._cb=[]),this._cb.push(e)),t in this._cbs||(this._cbs[t]=[]),-1===this._cbs[t].indexOf(e)&&this._cbs[t].push(e),this},t.prototype.any=function(e){return this.on(t.any,e),this},t.prototype.all=function(t,e){var n=this;return t.forEach(function(t){return n.on(t,e)}),this},t.prototype.once=function(t,e){var n=this,i=function(o,s,r){n.off(t,i),e(o,s,r)};return this.on(t,i),this},t.prototype.off=function(t,e){return t||(e?this._cb.splice(this._cbs[t].indexOf(e),1):(this._cb.length=0,delete this._cb)),t in this._cbs&&(e?this._cbs[t].splice(this._cbs[t].indexOf(e),1):(this._cbs[t].length=0,delete this._cbs[t])),this},t.prototype.emit=function(t,e){if(t in this._cbs)for(var n=0,i=this._cbs[t].length;n<i;n++)this._cbs[t][n](e,this._ctx,t);if(this._cb)for(var n=0,i=this._cb.length;n<i;n++)this._cb[n](e,this._ctx,t);return this},t.any="",t}(),d=function(e){function n(t,n,i){void 0===t&&(t="");var o=e.call(this,t)||this;return o._state=n,o.events=i||new a(o),o}return t(n,e),n.prototype.setState=function(t){return this._state=t,this.update(),this},n.prototype.getState=function(){return this._state},n}(c),u=function(e){function n(){var t=e.call(this,"TodoWidget")||this;return t.onInsert=function(e){var n=e.target.value.trim();n&&t.events.emit("insert",n)},t.onCompleteAll=function(e){var n=e.target.checked;t.events.emit("complete-all",n)},t.onComplete=function(e){var n=Number(e.target.dataset.id);t.events.emit("complete",n)},t.onDelete=function(e){var n=Number(e.target.dataset.id);t.events.emit("delete",n)},t.onClearCompleted=function(e){t.events.emit("clear-completed")},t.onEdit=function(e){var n=Number(e.target.dataset.id);t.events.emit("edit",n)},t.onEdited=function(e){var n=e.target.value.trim();n&&t.events.emit("edited",n)},t.setState({todo:"",todos:[],filter:"",edit:null}),t}return t(n,e),n.prototype.render=function(){var t=this,e=this._state.todos,n=this._state.todos.filter(function(t){return t.completed}),i=this._state.todos.filter(function(t){return!t.completed});switch(this._state.filter){case"active":e=i;break;case"completed":e=n}return[["section#app.todoapp",["header.header",["h1","todos"],["input.new-todo",{placeholder:"What needs to be done?",autofocus:"autofocus",value:new String(this._state.todo),change:this.onInsert}]],this._state.todos.length?["section.main",["input#toggle-all.toggle-all",{type:"checkbox",change:this.onCompleteAll}],["label",{for:"toggle-all"},"Mark all as complete"],["ul.todo-list"].concat(e.map(function(e){var n=[];return e.completed&&n.push("completed"),e.id===t._state.edit&&n.push("editing"),["li",{_key:e.id,classes:n},["div.view",["input.toggle",{type:"checkbox",data:{id:e.id},change:t.onComplete},function(t){return t.checked=e.completed}],["label",{data:{id:e.id},dblclick:t.onEdit},e.title],["button.destroy",{data:{id:e.id},click:t.onDelete}]],["input.edit",{value:new String(e.title),change:t.onEdited,blur:t.onEdited},function(t){return setTimeout(function(){return t.select()},0)}]]}))]:"",this._state.todos.length?["footer.footer",["span.todo-count",["strong",i.length],1===i.length?" item left":" items left"],["ul.filters",["li",["a",{href:"#",classes:""===this._state.filter?["selected"]:[]},"All"]],["li",["a",{href:"#active",classes:"active"===this._state.filter?["selected"]:[]},"Active"]],["li",["a",{href:"#completed",classes:"completed"===this._state.filter?["selected"]:[]},"Completed"]]],this._state.todos.filter(function(t){return t.completed}).length?["button.clear-completed",{click:this.onClearCompleted},"Clear completed"]:""]:""]]},n}(d),l=function(){function t(e){if(this._isLS=!1,"localStorage"in self)try{localStorage.getItem(t._key),this._isLS=!0}catch(t){console.warn(t)}this.read()||this.write(e)}return t.prototype.read=function(){return this._isLS?JSON.parse(localStorage.getItem(t._key)):this._data},t.prototype.write=function(e){this._isLS?localStorage.setItem(t._key,JSON.stringify(e)):this._data=e},t._key="todos-prest-lib",t}(),h=function(){function t(t,e){void 0===e&&(e=[]),this._initStore(e),this._initWidget(t),this._initRouting()}return t.prototype._initStore=function(t){this.store=new l(t)},t.prototype._initWidget=function(t){var e=this;this.todoWidget=(new u).setState({todo:"",todos:this.store.read(),filter:"",edit:null}),this.todoWidget.events.on("insert",function(t,e){var n={id:(new Date).getTime(),title:t,completed:!1};e.getState().todos.push(n),e.getState().todo="",e.update()}).on("complete-all",function(t,e){e.getState().todos.forEach(function(e){return e.completed=t}),e.update()}).on("complete",function(t,e){e.getState().todos.forEach(function(e){return e.id===t?e.completed=!e.completed:null}),e.update()}).on("delete",function(t,e){console.log("dddd",t),e.getState().todos=e.getState().todos.filter(function(e){return e.id!==t}),e.update()}).on("clear-completed",function(t,e){e.getState().todos=e.getState().todos.filter(function(t){return!t.completed}),e.update()}).on("edit",function(t,e){e.getState().edit=t,e.update()}).on("edited",function(t,e){e.getState().todos.forEach(function(n){return n.id===e.getState().edit?n.title=t:null}),e.getState().edit=null,e.update()}).any(function(t,n,i){console.log(i,JSON.stringify(t,null,4)),console.log("state",JSON.stringify(n.getState(),null,4)),e.store.write(n.getState().todos)}),this.todoWidget.mount(t)},t.prototype._initRouting=function(){var t=this;this.hash=(new s).coders(function(t){return encodeURIComponent(t)},function(t){return decodeURIComponent(t)}).onChange(function(e){switch(e){case"":case"active":case"completed":t.todoWidget.getState().filter=e,t.todoWidget.update(),t.todoWidget.events.emit("filter",e);break;default:t.todoWidget.getState().filter="",t.todoWidget.update(),t.todoWidget.events.emit("filter",e),t.hash.write("")}}).start()},t}(),f=[{id:(new Date).getTime(),title:"Learn prest-lib widgets",completed:!0},{id:(new Date).getTime()+1,title:"Add star to prest-lib",completed:!1}],p=new h(document.getElementById("app"),f);self.app=p,self.app.version="0.1.0"}();
//# sourceMappingURL=index.js.map
